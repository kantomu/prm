//@version=5
indicator("SMA Trend Filter", overlay=true, max_bars_back=500)

// ============================================================================
// è¨­å®š
// ============================================================================
group_sma = "ç§»å‹•å¹³å‡ç·šè¨­å®š"
len_9   = input.int(9,   "SMA 9 (ãƒˆãƒªã‚¬ãƒ¼)",       group=group_sma)
len_20  = input.int(20,  "SMA 20 (ä¸­æœŸãƒˆãƒ¬ãƒ³ãƒ‰)",  group=group_sma)
len_50  = input.int(50,  "SMA 50 (ä¸­æœŸãƒˆãƒ¬ãƒ³ãƒ‰)",  group=group_sma)
len_75  = input.int(75,  "SMA 75 (æ‹’å¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼)", group=group_sma)
len_200 = input.int(200, "SMA 200 (è¶…é•·æœŸ)",       group=group_sma)

group_filter = "ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®š"
pullback_bars     = input.int(10,  "æŠ¼ã—ç›®/æˆ»ã‚Šç›® åˆ¤å®šãƒãƒ¼æ•°",    group=group_filter, minval=1)
reject_trend_bars = input.int(100, "é€†å¼µã‚Šé˜²æ­¢ãƒãƒ¼æ•° (75SMA)",   group=group_filter, minval=1)
reject_ext_bars   = input.int(200, "è¡Œãéãè­¦æˆ’ãƒãƒ¼æ•° (75SMA)", group=group_filter, minval=1)
cooldown_bars     = input.int(10,  "ã‚·ã‚°ãƒŠãƒ«é‡è¤‡é˜²æ­¢ãƒãƒ¼æ•°",     group=group_filter, minval=1)

group_reynolds = "ğŸŒŒ ä¹±æµãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ (ãƒ¬ã‚¤ãƒãƒ«ã‚ºæ•°)"
re_length      = input.int(20,    "è¨ˆç®—æœŸé–“",           group=group_reynolds, minval=5)
re_threshold   = input.float(3.0, "ä¹±æµã—ãã„å€¤ (Re)",  group=group_reynolds, minval=0.5, step=0.1, tooltip="ã“ã®å€¤ã‚’è¶…ãˆã‚‹ã¨æ¥µç«¯ãªä¹±æµã¨åˆ¤å®šã—ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ‹’å¦")
show_re_bg     = input.bool(true, "ä¹±æµæ™‚ã«èƒŒæ™¯è¡¨ç¤º",   group=group_reynolds)

group_vix = "ğŸ“Š é©å¿œå‹VIXãƒ­ã‚¸ãƒƒã‚¯ (Adaptive Lookback)"
use_vix_adaptive = input.bool(true, "VIXã«ã‚ˆã‚‹æœŸé–“è‡ªå‹•èª¿æ•´ã‚’æœ‰åŠ¹åŒ–", group=group_vix)
vix_symbol       = input.symbol("CBOE:VIX", "VIXã‚·ãƒ³ãƒœãƒ«", group=group_vix)
base_vix         = input.float(20.0, "åŸºæº–VIXå€¤",          group=group_vix, tooltip="VIXãŒã“ã®å€¤ã‚ˆã‚Šé«˜ã„ã¨æœŸé–“çŸ­ç¸®(é«˜é€ŸåŒ–)ã€ä½ã„ã¨æœŸé–“å»¶é•·(å®‰å®šåŒ–)")
min_scale        = input.float(0.5,  "æœ€å°æœŸé–“å€ç‡",       group=group_vix, minval=0.1, maxval=1.0)
max_scale        = input.float(2.0,  "æœ€å¤§æœŸé–“å€ç‡",       group=group_vix, minval=1.0)

group_visual = "è¡¨ç¤ºè¨­å®š"
show_sma_9   = input.bool(true,  "SMA 9 è¡¨ç¤º",   group=group_visual)
show_sma_20  = input.bool(true,  "SMA 20 è¡¨ç¤º",  group=group_visual)
show_sma_50  = input.bool(true,  "SMA 50 è¡¨ç¤º",  group=group_visual)
show_sma_75  = input.bool(true,  "SMA 75 è¡¨ç¤º",  group=group_visual)
show_sma_200 = input.bool(true,  "SMA 200 è¡¨ç¤º", group=group_visual)

// ============================================================================
// ç§»å‹•å¹³å‡ç·šã®è¨ˆç®—
// ============================================================================
sma_9   = ta.sma(close, len_9)
sma_20  = ta.sma(close, len_20)
sma_50  = ta.sma(close, len_50)
sma_75  = ta.sma(close, len_75)
sma_200 = ta.sma(close, len_200)
ema_200 = ta.ema(close, len_200)  // 200EMAè¿½åŠ ï¼ˆæ‹’å¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç”¨ï¼‰

// ============================================================================
// ğŸŒŒ ãƒ¬ã‚¤ãƒãƒ«ã‚ºæ•°ã«ã‚ˆã‚‹ä¹±æµåˆ¤å®š (Physics & Fluid Dynamics)
// ============================================================================
// å¸‚å ´ã‚’ã€Œæµä½“ã€ã¨è¦‹ãªã—ã€ãƒˆãƒ¬ãƒ³ãƒ‰ã®ã€Œè³ªã€ã‚’ç‰©ç†è¨ˆç®—ã§è©•ä¾¡
// Re = é€Ÿåº¦(Momentum) / ç²˜æ€§(1/Volatility) = Momentum Ã— Volatility
// ä½Re = å±¤æµï¼ˆæ»‘ã‚‰ã‹ãªãƒˆãƒ¬ãƒ³ãƒ‰ï¼‰â†’ ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ¨å¥¨
// é«˜Re = ä¹±æµï¼ˆä¹±é«˜ä¸‹ï¼‰â†’ ã‚¨ãƒ³ãƒˆãƒªãƒ¼å›é¿

// ãƒ¢ãƒ¡ãƒ³ã‚¿ãƒ ï¼ˆé€Ÿåº¦ï¼‰: ä¾¡æ ¼å¤‰å‹•ã®çµ¶å¯¾å€¤
momentum = math.abs(close - close[re_length])

// ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆç²˜æ€§ã®é€†æ•°ï¼‰: æ¨™æº–åå·®
volatility = ta.stdev(close, re_length)

// å¹³å‡ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆæ­£è¦åŒ–ç”¨ï¼‰
avg_volatility = ta.sma(volatility, re_length * 2)

// ãƒ¬ã‚¤ãƒãƒ«ã‚ºæ•°ã®è¨ˆç®—ï¼ˆæ­£è¦åŒ–ï¼‰
// Re = (Momentum / AvgVolatility) Ã— (Volatility / AvgVolatility)
re_momentum_norm  = nz(momentum / avg_volatility, 0)
re_volatility_norm = nz(volatility / avg_volatility, 1)
reynolds_number = re_momentum_norm * re_volatility_norm

// æ¥µç«¯ãªä¹±æµåˆ¤å®šï¼ˆã—ãã„å€¤è¶…éæ™‚ã®ã¿æ‹’å¦ï¼‰
is_extreme_turbulence = reynolds_number > re_threshold

// ============================================================================
// ğŸ“Š é©å¿œå‹VIXãƒ­ã‚¸ãƒƒã‚¯ (Adaptive VIX Lookback)
// ============================================================================
// ææ€–æŒ‡æ•° (VIX) ã‚’å–å¾—ã—ã€å¸‚å ´ã®ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ã«åˆã‚ã›ã¦æœŸé–“ã‚’è‡ªå‹•èª¿æ•´
// VIXé«˜ = æœŸé–“å€ç‡ < 1.0 (æœŸé–“çŸ­ç¸® = é«˜é€Ÿåå¿œ)
// VIXä½ = æœŸé–“å€ç‡ > 1.0 (æœŸé–“å»¶é•· = ãƒ€ãƒã‚·å›é¿)

// VIXãƒ‡ãƒ¼ã‚¿ã®å–å¾—ï¼ˆæ—¥è¶³ã®çµ‚å€¤ã‚’ä½¿ç”¨ã€ã‚®ãƒ£ãƒƒãƒ—åŸ‹ã‚ã‚ã‚Šï¼‰
vix_close = request.security(vix_symbol, "D", close, gaps=barmerge.gaps_off)

// æœŸé–“å€ç‡ã®è¨ˆç®—
// VIXãŒé«˜ã„ã»ã©å€ç‡ã¯å°ã•ããªã‚‹ (ä¾‹: Base=20, Cur=30 -> 20/30 = 0.66)
// VIXãŒä½ã„ã»ã©å€ç‡ã¯å¤§ãããªã‚‹ (ä¾‹: Base=20, Cur=10 -> 20/10 = 2.0)
vix_ratio = 1.0
if use_vix_adaptive and not na(vix_close) and vix_close > 0
    raw_ratio = base_vix / vix_close
    vix_ratio := math.max(min_scale, math.min(max_scale, raw_ratio))

// å‹•çš„ãªæœŸé–“è¨­å®š
// intå‹ã«ã‚­ãƒ£ã‚¹ãƒˆã—ã¦ä½¿ç”¨
d_pullback_bars     = math.max(1, math.round(pullback_bars * vix_ratio))
d_reject_trend_bars = math.max(1, math.round(reject_trend_bars * vix_ratio))
d_reject_ext_bars   = math.max(1, math.round(reject_ext_bars * vix_ratio))
// cooldownã¯ã‚·ã‚°ãƒŠãƒ«é »åº¦ã«é–¢ã‚ã‚‹ãŸã‚å›ºå®šãŒè‰¯ã„å ´åˆã‚‚ã‚ã‚‹ãŒã€ã“ã“ã§ã¯é©å¿œã•ã›ã‚‹
d_cooldown_bars     = math.max(1, math.round(cooldown_bars * vix_ratio))

// ãƒ‡ãƒãƒƒã‚°ç”¨ï¼ˆãƒ‡ãƒ¼ã‚¿ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«è¡¨ç¤ºï¼‰
// plotchar(vix_ratio, "VIX Ratio", "", location.top)
// plotchar(d_pullback_bars, "Dyn Pullback", "", location.top)

// ============================================================================
// ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: é€£ç¶šä¸‹è½/ä¸Šæ˜‡ã®åˆ¤å®š
// ============================================================================
// æŒ‡å®šã•ã‚ŒãŸSMAãŒéå»næœ¬é€£ç¶šã§ä¸‹è½ã—ã¦ã„ã‚‹ã‹ã‚’åˆ¤å®š
f_consecutive_decline(float src, int bars) =>
    result = true
    for i = 0 to bars - 1
        if nz(src[i]) >= nz(src[i + 1])
            result := false
            break
    result

// æŒ‡å®šã•ã‚ŒãŸSMAãŒéå»næœ¬é€£ç¶šã§ä¸Šæ˜‡ã—ã¦ã„ã‚‹ã‹ã‚’åˆ¤å®š
f_consecutive_rise(float src, int bars) =>
    result = true
    for i = 0 to bars - 1
        if nz(src[i]) <= nz(src[i + 1])
            result := false
            break
    result

// ============================================================================
// ã‚·ã‚°ãƒŠãƒ«æ¡ä»¶ã®è¨ˆç®—
// ============================================================================

// --- ãƒ­ãƒ³ã‚°æ¡ä»¶ ---

// 1. åŸºæœ¬ãƒˆãƒ¬ãƒ³ãƒ‰: 20SMA ã¨ 50SMA ãŒ 200SMA ã‚ˆã‚Šä¸Š
long_trend = sma_20 > sma_200 and sma_50 > sma_200

// 2. èª¿æ•´ï¼ˆæŠ¼ã—ç›®ï¼‰: 20SMA ã¨ 50SMA ãŒç›´è¿‘næœ¬é€£ç¶šã§ä¸‹è½ï¼ˆå‹•çš„æœŸé–“ï¼‰
long_pullback = f_consecutive_decline(sma_20, int(d_pullback_bars)) and f_consecutive_decline(sma_50, int(d_pullback_bars))

// 3. åè»¢ãƒˆãƒªã‚¬ãƒ¼: 9SMA ãŒä¸Šæ˜‡ã«è»¢ã˜ãŸ
long_trigger = sma_9 > sma_9[1]

// 4. 75SMAæ‹’å¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
//    - é€†å¼µã‚Šé˜²æ­¢: 75SMAãŒéå»100æœ¬é€£ç¶šã§ä¸‹è½ã—ã¦ã„ãªã„
//    - é«˜å€¤è­¦æˆ’: 75SMAãŒéå»200æœ¬é€£ç¶šã§ä¸Šæ˜‡ã—ã¦ã„ãªã„
// 4. 75SMAæ‹’å¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
//    - é€†å¼µã‚Šé˜²æ­¢: 75SMAãŒéå»næœ¬é€£ç¶šã§ä¸‹è½ã—ã¦ã„ãªã„ï¼ˆå‹•çš„æœŸé–“ï¼‰
//    - é«˜å€¤è­¦æˆ’: 75SMAãŒéå»næœ¬é€£ç¶šã§ä¸Šæ˜‡ã—ã¦ã„ãªã„ï¼ˆå‹•çš„æœŸé–“ï¼‰
long_reject_trend  = not f_consecutive_decline(sma_75, int(d_reject_trend_bars))
long_reject_extend = not f_consecutive_rise(sma_75, int(d_reject_ext_bars))

// 5. MAé †åºã«ã‚ˆã‚‹æ‹’å¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
//    ä¸Šã‹ã‚‰ 75SMA > 200SMA > 200EMA ã®é †åºã¯ä¸Šæ˜‡ãƒˆãƒ¬ãƒ³ãƒ‰æ§‹é€  â†’ ãƒ­ãƒ³ã‚°æ‹’å¦ï¼ˆè¡Œãéãè­¦æˆ’ï¼‰
//    ãŸã ã—ã€75SMAãŒ20æœŸé–“é€£ç¶šä¸Šæ˜‡ä¸­ãªã‚‰ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ï¼ˆå¼·ã„ãƒ¢ãƒ¡ãƒ³ã‚¿ãƒ ï¼‰
long_ma_order_base = sma_75 > sma_200 and sma_200 > ema_200
long_momentum_override = f_consecutive_rise(sma_75, 20)
long_ma_order_reject = long_ma_order_base and not long_momentum_override

long_filter = long_reject_trend and long_reject_extend and not long_ma_order_reject

// --- ã‚·ãƒ§ãƒ¼ãƒˆæ¡ä»¶ ---

// 1. åŸºæœ¬ãƒˆãƒ¬ãƒ³ãƒ‰: 20SMA ã¨ 50SMA ãŒ 200SMA ã‚ˆã‚Šä¸‹
short_trend = sma_20 < sma_200 and sma_50 < sma_200

// 2. èª¿æ•´ï¼ˆæˆ»ã‚Šç›®ï¼‰: 20SMA ã¨ 50SMA ãŒç›´è¿‘næœ¬é€£ç¶šã§ä¸Šæ˜‡ï¼ˆå‹•çš„æœŸé–“ï¼‰
short_pullback = f_consecutive_rise(sma_20, int(d_pullback_bars)) and f_consecutive_rise(sma_50, int(d_pullback_bars))

// 3. åè»¢ãƒˆãƒªã‚¬ãƒ¼: 9SMA ãŒä¸‹è½ã«è»¢ã˜ãŸ
short_trigger = sma_9 < sma_9[1]

// 4. 75SMAæ‹’å¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
//    - é€†å¼µã‚Šé˜²æ­¢: 75SMAãŒéå»100æœ¬é€£ç¶šã§ä¸Šæ˜‡ã—ã¦ã„ãªã„
//    - åº•å€¤è­¦æˆ’: 75SMAãŒéå»200æœ¬é€£ç¶šã§ä¸‹è½ã—ã¦ã„ãªã„
// 4. 75SMAæ‹’å¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
//    - é€†å¼µã‚Šé˜²æ­¢: 75SMAãŒéå»næœ¬é€£ç¶šã§ä¸Šæ˜‡ã—ã¦ã„ãªã„ï¼ˆå‹•çš„æœŸé–“ï¼‰
//    - åº•å€¤è­¦æˆ’: 75SMAãŒéå»næœ¬é€£ç¶šã§ä¸‹è½ã—ã¦ã„ãªã„ï¼ˆå‹•çš„æœŸé–“ï¼‰
short_reject_trend  = not f_consecutive_rise(sma_75, int(d_reject_trend_bars))
short_reject_extend = not f_consecutive_decline(sma_75, int(d_reject_ext_bars))

// 5. MAé †åºã«ã‚ˆã‚‹æ‹’å¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
//    ä¸‹ã‹ã‚‰ 75SMA < 200SMA < 200EMA ã®é †åºã¯ä¸‹é™ãƒˆãƒ¬ãƒ³ãƒ‰æ§‹é€  â†’ ã‚·ãƒ§ãƒ¼ãƒˆæ‹’å¦ï¼ˆè¡Œãéãè­¦æˆ’ï¼‰
//    ãŸã ã—ã€75SMAãŒ20æœŸé–“é€£ç¶šä¸‹è½ä¸­ãªã‚‰ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ï¼ˆå¼·ã„ãƒ¢ãƒ¡ãƒ³ã‚¿ãƒ ï¼‰
short_ma_order_base = sma_75 < sma_200 and sma_200 < ema_200
short_momentum_override = f_consecutive_decline(sma_75, 20)
short_ma_order_reject = short_ma_order_base and not short_momentum_override

short_filter = short_reject_trend and short_reject_extend and not short_ma_order_reject

// ============================================================================
// é‡è¤‡é˜²æ­¢ãƒ­ã‚¸ãƒƒã‚¯
// ============================================================================
var int bars_since_long  = 200 // åˆæœŸå€¤ã‚’ååˆ†ã«å¤§ãã
var int bars_since_short = 200

bars_since_long  := bars_since_long  + 1
bars_since_short := bars_since_short + 1

// ============================================================================
// ã‚·ã‚°ãƒŠãƒ«åˆ¤å®š
// ============================================================================
long_raw  = long_trend and long_pullback and long_trigger and long_filter
short_raw = short_trend and short_pullback and short_trigger and short_filter

// ğŸŒŒ ä¹±æµãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ + é‡è¤‡é˜²æ­¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
// æ¥µç«¯ãªä¹±æµæ™‚ã¯ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã‚’æ‹’å¦
// ğŸŒŒ ä¹±æµãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ + é‡è¤‡é˜²æ­¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
// æ¥µç«¯ãªä¹±æµæ™‚ã¯ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã‚’æ‹’å¦ + å‹•çš„ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³æœŸé–“ã‚’ä½¿ç”¨
long_signal  = long_raw and bars_since_long > d_cooldown_bars and not is_extreme_turbulence
short_signal = short_raw and bars_since_short > d_cooldown_bars and not is_extreme_turbulence

// ã‚·ã‚°ãƒŠãƒ«ç™ºç”Ÿæ™‚ã«ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
if long_signal
    bars_since_long := 0
if short_signal
    bars_since_short := 0

// ============================================================================
// æç”»: ç§»å‹•å¹³å‡ç·š
// ============================================================================
plot(show_sma_9   ? sma_9   : na, "SMA 9",   color=color.new(color.yellow, 0), linewidth=1)
plot(show_sma_20  ? sma_20  : na, "SMA 20",  color=color.new(color.orange, 0), linewidth=1)
plot(show_sma_50  ? sma_50  : na, "SMA 50",  color=color.new(color.blue, 0),   linewidth=2)
plot(show_sma_75  ? sma_75  : na, "SMA 75",  color=color.new(color.purple, 0), linewidth=2)
plot(show_sma_200 ? sma_200 : na, "SMA 200", color=color.new(color.red, 0),    linewidth=3)

// ğŸŒŒ ãƒ¬ã‚¤ãƒãƒ«ã‚ºæ•°ã«ã‚ˆã‚‹ä¹±æµèƒŒæ™¯è¡¨ç¤º
bgcolor(show_re_bg and is_extreme_turbulence ? color.new(color.orange, 85) : na, title="æ¥µç«¯ä¹±æµè­¦å‘Š")

// ============================================================================
// æç”»: ã‚·ã‚°ãƒŠãƒ«çŸ¢å°
// ============================================================================
plotshape(long_signal,  title="ãƒ­ãƒ³ã‚°ã‚·ã‚°ãƒŠãƒ«",  location=location.belowbar, color=color.new(color.lime, 0),  style=shape.triangleup,   size=size.normal, text="LONG")
plotshape(short_signal, title="ã‚·ãƒ§ãƒ¼ãƒˆã‚·ã‚°ãƒŠãƒ«", location=location.abovebar, color=color.new(color.red, 0),   style=shape.triangledown, size=size.normal, text="SHORT")

// ============================================================================
// ã‚¢ãƒ©ãƒ¼ãƒˆ
// ============================================================================
alertcondition(long_signal,  title="ãƒ­ãƒ³ã‚°ã‚·ã‚°ãƒŠãƒ«",  message="SMA Trend Filter: ãƒ­ãƒ³ã‚°ã‚·ã‚°ãƒŠãƒ«ç™ºç”Ÿ")
alertcondition(short_signal, title="ã‚·ãƒ§ãƒ¼ãƒˆã‚·ã‚°ãƒŠãƒ«", message="SMA Trend Filter: ã‚·ãƒ§ãƒ¼ãƒˆã‚·ã‚°ãƒŠãƒ«ç™ºç”Ÿ")
