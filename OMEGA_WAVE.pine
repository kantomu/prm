//@version=5
indicator("OMEGA WAVE [TITAN EDITION]", shorttitle="Î© WAVE TITAN", overlay=true, max_bars_back=4000, max_lines_count=500, max_boxes_count=500, max_labels_count=500)

// =============================================================================
// OMEGA WAVE: TITAN EDITION (Ver 1.0)
// =============================================================================
// "System of Systems" - The Ultimate Wave 3 Engine
//
// [ Architecture Overview ]
// 1. ADVANCED MATH KERNEL (The constant laws of Physics)
//    - Fractal Dimension (Hurst), Shannon Entropy, Fluid Dynamics (Reynolds), Kalman Filters
// 2. STRUCTURAL RECOGNITION (The shape of the market)
//    - Elliott Wave (Recursive), Wyckoff Events (A-E), ICT Concepts (OB/FVG)
// 3. ENERGY DYNAMICS (The fuel)
//    - Volume Delta, Momentum, Vigor, Money Flow
// 4. SYNTHESIS ENGINE (The Judge)
//    - Weighted Voting Mechanism
//
// Designed for 10-Year Robustness. No Curve Fitting. Pure Market Mechanics.
// =============================================================================

// ==========================================
// âš™ï¸ SETTINGS (MASTER CONTROL)
// ==========================================

// --- UNIVERSE SETTINGS ---
grp_univ = "ğŸŒŒ UNIVERSE (General)"
mode_sens = input.string("Standard", "Sensitivity Mode", options=["Conservative", "Standard", "Aggressive", "God Mode"], group=grp_univ)
show_dashboard = input.bool(true, "Show Titan Dashboard", group=grp_univ)
show_debug = input.bool(false, "Show Debug Labels", group=grp_univ)

// --- PHYSICS LAYER ---
grp_phys = "âš›ï¸ PHYSICS ENGINE"
len_hurst = input.int(30, "Fractal Dimension Lookback", group=grp_phys)
len_entropy = input.int(20, "Entropy Lookback", group=grp_phys)
len_reynolds = input.int(14, "Fluid Dynamics Lookback", group=grp_phys)
th_laminar = input.float(1.35, "Laminar Flow Threshold (FD)", step=0.01, group=grp_phys)
th_trubulence = input.float(1.6, "Turbulence Threshold (FD)", step=0.01, group=grp_phys)

// --- STRUCTURE LAYER ---
grp_struct = "ğŸ“ STRUCTURE ENGINE"
ew_pivot_len = input.int(10, "Elliott Wave Pivot Length", group=grp_struct)
wyckoff_len = input.int(50, "Wyckoff Range Length", group=grp_struct)
show_ict = input.bool(true, "Show ICT Order Blocks", group=grp_struct)
show_ew = input.bool(true, "Show Elliott Wave Counts", group=grp_struct)

// --- ENERGY LAYER ---
grp_energy = "âš¡ ENERGY ENGINE"
len_delta = input.int(14, "Pseudo Delta Length", group=grp_energy)
vol_factor = input.float(1.5, "Volume Spike Factor", group=grp_energy)

// ==========================================
// ğŸ“š TITAN MATH KERNEL
// ==========================================

// --- 1. Normalized Calculation ---
f_norm(_src, _len) =>
    _min = ta.lowest(_src, _len)
    _max = ta.highest(_src, _len)
    _range = _max - _min
    _range != 0 ? (_src - _min) / _range : 0.0

f_zscore(_src, _len) =>
    _avg = ta.sma(_src, _len)
    _std = ta.stdev(_src, _len)
    _std != 0 ? (_src - _avg) / _std : 0.0

// --- 2. Advanced Fractal Geometry ---
// Rescaled Range Analysis approximation for Hurst Exponent
f_fractal_dim(_src, _len) =>
    // Calculate Range
    float _r = ta.highest(_src, _len) - ta.lowest(_src, _len)
    // Calculate StdDev
    float _s = ta.stdev(_src, _len)
    // Avoid division by zero
    float _rs = (_s != 0) ? _r / _s : 0
    // Log-Log Relation (simplified)
    // H = log(RS) / log(N)
    // D = 2 - H
    float _hurst = (_rs > 0) ? math.log(_rs) / math.log(_len) : 0.5
    float _dim = 2.0 - _hurst
    _dim // 1.0 = Highly Trended, 1.5 = Random, 2.0 = Mean Reverting

// --- 3. Shannon Entropy (Information Theory) ---
// Measures the amount of "disorder" or "unpredictability" in price action
f_entropy(_src, _len) =>
    float _sum = 0.0
    for i = 0 to _len-1
        // Probability of price change (simplified as normalized change)
        float _change = math.abs(_src[i] - _src[i+1])
        float _log_p = (_change > 0) ? math.log(_change) : 0
        _sum += (_change * _log_p)
    // Theoretical max entropy for length N is log(N)
    // We return a raw metric inversely related to order
    -_sum / _len

// --- 4. Fluid Dynamics (Reynolds Number) ---
// Re = (Velocity * Characteristic Length) / Kinematic Viscosity
// Velocity = Momentum (Close - Close[N])
// Length = ATR (Volatility)
// Viscosity = Standard Deviation (Internal Friction)
f_reynolds(_src, _len) =>
    float _velocity = math.abs(_src - _src[_len])
    float _viscosity = ta.stdev(_src, _len)
    float _re = (_viscosity > 0) ? _velocity / _viscosity : 0.0
    _re

// --- 5. Kalman Filter (Signal Processing) ---
// Reduces noise with minimal lag compared to MA
f_kalman(_src, _g, _dk) =>
    var float _kf = 0.0
    var float _v = 0.0
    _kf := na(_kf[1]) ? _src : _kf[1]
    _err = _src - _kf
    _kf := _kf + _g * _err + _v
    _v := _v + _dk * _err
    _kf // Returns the filtered price

// ==========================================
// ğŸ—ï¸ PHYSICS ENGINE EXECUTION
// ==========================================

// Calculate Physics State
float val_fd = f_fractal_dim(close, len_hurst)
float val_ent = f_entropy(close, len_entropy)
float val_re = f_reynolds(close, len_reynolds)
float val_kalman = f_kalman(close, 0.05, 0.01)

// Classify State
bool state_laminar = (val_fd < th_laminar) // Smooth Trend
bool state_turbulent = (val_fd > th_trubulence) // Choppy / Chaos
bool state_transition = not state_laminar and not state_turbulent

// Normalized Physics Score (-10 to +10)
// Laminar = +10, Transition = 0, Turbulent = -10
float score_phys = 0.0
if state_laminar
    score_phys := 10.0 + (val_re * 2.0) // Bonus for high Reynolds (Strong Flow)
else if state_turbulent
    score_phys := -10.0 // Veto
else
    score_phys := 0.0

// ==========================================
// ğŸ“ STRUCTURE ENGINE EXECUTION
// ==========================================

// --- 1. Elliott Wave (Recursive Pivot Logic) ---
// W3 Rules:
// - W3 is usually 1.618 or 2.618 of W1
// - W3 cannot be the shortest
// - W2 cannot retrace > 100% of W1
var int ew_cycle = 0 // 0=Null, 1=W1, 2=W2, 3=W3, 4=W4, 5=W5
var float p0 = na, var float p1 = na, var float p2 = na, var float p3 = na

int ph = ta.pivothigh(ew_pivot_len, ew_pivot_len)
int pl = ta.pivotlow(ew_pivot_len, ew_pivot_len)
// Note: Pivot detection is lagging by 'ew_pivot_len' bars. We project forward.

// Update Structure Points
if not na(ph)
    // If we were in W1 or W3, this might be end of impulse
    // Simplified logic for "Real-time" estimation
    // If High > p1, potential W3 peak forming
    na

if not na(pl)
    // If Low > p0, potential W2 or W4
    na

// Real-time W3 Detection Logic (The "Sniper" Logic)
// We look for: Breakout of P1 (W1 Top) + High Momentum + Laminar Flow
var float w1_top = na
var float w2_btm = na
var bool in_w3_zone = false

if not na(ph)
    w1_top := ph
if not na(pl)
    if not na(w1_top)
        w2_btm := pl

// Wave 3 Ignition Condition
bool ew_w3_start = false
if not na(w1_top) and not na(w2_btm)
    // Price breaks W1 Top
    if ta.crossover(close, w1_top) and w2_btm > (w1_top - (w1_top*0.05)) // Sanity check, W2 isn't too deep logic handled elsewhere
        ew_w3_start := true
        in_w3_zone := true

// Wave 4/5 Check (Invalidation)
if in_w3_zone and close < w1_top // Failed W3 or W4 pullback
    in_w3_zone := false

float score_ew = 0.0
if ew_w3_start
    score_ew := 10.0
else if in_w3_zone
    score_ew := 8.0

// --- 2. Wyckoff Events (Schematic Logic) ---
// Looking for Sign of Strength (SOS) after Spring
float w_high = ta.highest(wyckoff_len)
float w_low = ta.lowest(wyckoff_len)
bool is_range = (w_high - w_low) / ta.atr(14) < 15.0 // Tightness check

// Spring Detection: Price dips below range low, then reclaims
bool is_spring = false
if low < w_low[1] and close > w_low[1] and is_range[1]
    is_spring := true

// SOS Detection: Strong breakout with volume
bool is_sos = false
if close > w_high[1] and volume > ta.sma(volume, 20)*1.5 and is_range[1]
    is_sos := true

float score_wyckoff = 0.0
if is_spring
    score_wyckoff := 5.0
if is_sos
    score_wyckoff := 8.0

// --- 3. ICT / Smart Money Concepts ---
// Order Blocks (Bullish)
// Last bearish candle before a BOS (Break of Structure)
var box ob_active = na
bool bos = ta.crossover(close, ta.highest(high, 10)[1])
bool bear_candle = close < open

if bos and bear_candle[1]
    // Identify OB
    float ob_h = high[1]
    float ob_l = low[1]
    if show_ict
        box.new(bar_index-1, ob_h, bar_index+5, ob_l, bgcolor=color.new(color.blue, 80), border_color=na)
    score_struct := score_struct + 3.0 // Bonus for OB creation

// FVG (Fair Value Gap)
bool fvg = (low > high[2])
if fvg
    score_struct := score_struct + 2.0 // Bonus for FVG

// Total Structure Score
float score_struct = score_ew + score_wyckoff

// ==========================================
// âš¡ ENERGY ENGINE EXECUTION
// ==========================================

// --- 1. Pseudo Delta (Intrabar Volume) ---
f_delta() =>
    float _r = high - low
    float _b = math.abs(close - open)
    float _ratio = (_r > 0) ? _b / _r : 0.0
    float _vol_dir = (close > open) ? volume * _ratio : -volume * _ratio
    _vol_dir

float val_delta = f_delta()
float avg_delta = ta.sma(val_delta, len_delta)

// --- 2. Momentum / Vigor ---
float rvi = ta.rsi(close, 14) // Simplified proxy for Vigor
bool mom_bull = rvi > 50 and rvi < 80 // Healthy Bullish

// --- 3. Volume Spike Check ---
float vol_ma = ta.sma(volume, 50)
bool vol_imbalance = volume > vol_ma * vol_factor

float score_energy = 0.0
if val_delta > 0 and val_delta > avg_delta
    score_energy += 3.0
if mom_bull
    score_energy += 2.0
if vol_imbalance and close > open
    score_energy += 5.0 // High impact

// ==========================================
// ğŸ—³ï¸ SYNTHESIS ENGINE (THE JUDGE)
// ==========================================
// Consensus Logic
// ----------------
// Physics Weight: 40%
// Structure Weight: 40%
// Energy Weight: 20%

float w_phys = 0.4
float w_struct = 0.4
float w_energy = 0.2

// Total Score Calculation (0 - 100 Scale approx)
// Base scores are roughly 0-10, so we multiply by 10
float total_score = (score_phys * w_phys * 10) + (score_struct * w_struct * 10) + (score_energy * w_energy * 10)

// Sensitivity Thresholds
float th_fire = mode_sens == "Conservative" ? 60.0 : (mode_sens == "Aggressive" ? 40.0 : 50.0)
if mode_sens == "God Mode"
    th_fire := 30.0 // See everything

// SIGNAL GENERATION
bool sig_w3_ignition = (total_score >= th_fire) and not (total_score[1] >= th_fire)
bool sig_veto = (score_phys < -5.0) // Absolute Physics Veto (Turbulence)

// ==========================================
// ğŸ¨ VISUALIZATION (THE GOD VIEW)
// ==========================================

// 1. BACKGROUND IGNITION
// Green flash on W3 Ignition
bgcolor(sig_w3_ignition ? color.new(#00E676, 20) : na, title="W3 Ignition Flash")

// 2. CANDLE COLORING
// Green = W3 Impulse (High Score)
// Blue = Setup / Structure Building (Medium Score)
// Gray = Turbulence / Veto (Negative Physics)
// Red = Bearish Impulse (Inverse Logic would go here)
color c_candle = na
if sig_veto
    c_candle := color.gray
else if total_score > th_fire
    c_candle := #00E676 // Matrix Green
else if total_score > 20
    c_candle := #2979FF // Electric Blue
else
    c_candle := #546E7A // Dull BlueGray

barcolor(c_candle, title="Omega Bar Color")

// 3. PLOTS
// Trailing Stop (Omega Trail)
var float o_trail = na
if total_score > 20 and not sig_veto // Active Mode
    float t_dist = ta.atr(14) * (state_laminar ? 3.0 : 1.5) // Dynamic ATR
    float t_val = close - t_dist
    o_trail := na(o_trail[1]) ? t_val : math.max(o_trail[1], t_val)
    if close < o_trail
        o_trail := na // Reset
else
    o_trail := na

plot(o_trail, "Î© Trail", color=color.new(#00B0FF, 0), linewidth=2, style=plot.style_linebr)

// 4. SIGNALS
plotshape(sig_w3_ignition, "Î© TRIGGER", shape.diamond, location.belowbar, color.white, size=size.tiny)

// 5. DASHBOARD (TITAN HUD)
if show_dashboard and barstate.islast
    string pd = "Physics: " + (state_laminar ? "LAMINAR ğŸŒŠ" : (state_turbulent ? "CHAOS ğŸŒªï¸" : "NEUTRAL")) + " (" + str.tostring(val_fd, "#.##") + ")\n"
    string sd = "Struct : " + (score_struct > 5 ? "W3 BREAK ğŸ“" : "BUILDING") + "\n"
    string ed = "Energy : " + (score_energy > 5 ? "SURGE ğŸ”¥" : "NORMAL") + "\n"
    string sc = "SCORE  : " + str.tostring(total_score, "#.0") + " / " + str.tostring(th_fire)
    string hud = "Î© TITAN ENGINE\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n" + pd + sd + ed + "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n" + sc
    
    label.new(bar_index + 3, high, hud, color=color.new(#101010, 20), textcolor=color.white, style=label.style_label_left, textalign=text.align_left)

// 6. ALERTS
alertcondition(sig_w3_ignition, "Î© WAVE 3 IGNITION", "Massive Impulse Detected by Titan Engine")
alertcondition(state_laminar, "Laminar Flow Detected", "Market entering high-efficiency state")
